<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pencarian Buku - Perpustakaan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
/* --- BOX-SIZING UNIVERSAL --- */
*, *::before, *::after {
    box-sizing: border-box;
}

/* --- VARIABEL DASAR --- */
:root {
    --primary-color: #00bcd4;     /* Biru terang konsisten */
    --text-dark: #006064;         /* Warna teks utama */
    --bg-main: #fcfcfc;           /* PUTIH PUCAT (Off-White) untuk container utama */
    --bg-body: #f7f9fc;           /* Abu-abu muda sangat lembut untuk body */
    --border-light: #e0e0e0;      /* Border yang lembut */
    --warning-orange: #f39c12; 
    --success-green: #2ecc71; 
}

/* 1. Latar Belakang Body */
body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: var(--bg-body); /* Background abu-abu muda */
    margin: 0; 
    padding: 20px 15px; 
    color: var(--text-dark); 
}

/* 2. Container Pembungkus */
.container {
    max-width: 1200px; /* Lebar maksimum container */
    margin: auto;
    /* Optional: Memberikan background off-white untuk kontras yang nyaman */
    background: var(--bg-body);
    padding: 20px;
    border-radius: 12px;

}

/* --- Area Pencarian --- */
#searchContainer { 
    margin-bottom: 25px; 
    text-align: center; 
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
}
#searchInput {
    padding: 12px 20px; 
    border: 1px solid var(--border-light); /* Border lebih lembut */
    border-radius: 30px; 
    width: 100%; 
    font-size: 1.1em; 
    transition: border-color 0.3s, box-shadow 0.3s;
    outline: none;
    background-color: #ffffff; /* Pastikan input tetap putih */
}
#searchInput:focus { 
    border-color: var(--primary-color); 
    box-shadow: 0 0 8px rgba(0, 188, 212, 0.3); 
}

/* --- Container Hasil Buku --- */
#bukuContainer {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
    gap: 20px; 
    padding: 0;
}

/* 3. Gaya Card Buku */
.buku-card {
    background: #ffffff; /* Card tetap putih murni */
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08); /* Shadow sedikit lebih halus */
    padding: 15px; 
    transition: box-shadow 0.3s, transform 0.2s; 
    border-left: 5px solid var(--primary-color); 
    position: relative;
    display: flex; 
    flex-direction: column;
}
.buku-card:hover {
    box-shadow: 0 6px 15px rgba(0,0,0,0.12);
    transform: translateY(-2px); 
}

/* Gaya khusus jika sedang dipinjam */
.buku-card.dipinjam {
    border-left: 5px solid var(--warning-orange);
    opacity: 0.98;
}


.card-title {
    font-size: 1.2em; 
    font-weight: 700;
    color: var(--text-dark);
    margin: 0 0 10px 0;
    line-height: 1.4;
    display: flex;
    align-items: flex-start;
}

.card-title i {
    flex-shrink: 0;
    margin-right: 10px;
    color: var(--primary-color);
    font-size: 1.3em;
}

.card-content {
    flex-grow: 1; 
}

.card-detail {
    margin-bottom: 8px; 
    padding: 6px 0; 
    display: flex; 
    align-items: center;
    font-size: 0.95em;
    border-top: 1px dashed #eee;
}

.card-detail:first-of-type {
    border-top: none; 
}

.card-detail i {
    flex-shrink: 0;
    margin-right: 8px;
    color: #7f8c8d;
    width: 20px; 
    text-align: center;
}

.detail-label {
    font-weight: 600;
    color: #34495e;
    margin-right: 5px;
}

.detail-value {
    color: var(--text-dark);
}

/* --- Status Ketersediaan di Bagian Bawah --- */
.card-status {
    margin-top: 15px; 
    padding-top: 10px;
    border-top: 2px solid var(--border-light);
    text-align: center;
    font-weight: 700;
    padding-bottom: 5px;
    text-transform: uppercase;
}

.status-available {
    color: var(--success-green);
}

.status-borrowed {
    color: var(--warning-orange);
}


/* --- Pesan Status (Loading/Tidak Ditemukan) --- */
/* Elemen statusMessage masih dipertahankan di CSS jika sewaktu-waktu dibutuhkan, 
   namun tidak digunakan secara default di HTML dan JS yang dimodifikasi. */
#statusMessage {
    text-align: center;
    padding: 20px;
    color: #34495e;
    font-size: 1.1em;
}

</style>
</head>
<body>

<div class="container">
    <div id="searchContainer">
        <input type="text" id="searchInput" placeholder="Cari Judul, Pengarang, atau No. Inventaris..." oninput="filterBooks()" autocomplete="off">
    </div>

    <div id="bukuContainer">
        </div>
</div>

<script>
// --- Konfigurasi Firebase ---
const firebaseConfig = {
    // Pastikan ini konfigurasi yang benar dari file Anda
    apiKey: "AIzaSyByw2om-sKHqgCWBDcE7FEtONoUoJbn9M",
    authDomain: "traying-29bf4.firebaseapp.com",
    databaseURL: "https://traying-29bf4-default-rtdb.firebaseio.com",
    projectId: "traying-29bf4",
    storageBucket: "traying-29bf4.appspot.com",
    messagingSenderId: "42080663883",
    appId: "1:42080663883:web:58f28d5d1164204457d030"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- PATH KONSISTEN ---
const BUKU_PATH = "buku_v2"; 
const PEMINJAMAN_PATH = "peminjaman_v2"; 

// --- STATE GLOBAL & ELEMEN ---
let allBukuData = {};
let activePeminjamanInvs = new Set(); 
const bukuContainer = document.getElementById("bukuContainer");
const searchInput = document.getElementById("searchInput");
// statusMessage tetap didefinisikan untuk mencegah error, tapi tidak dipanggil
const statusMessage = document.getElementById('statusMessage'); 


// --- HELPER FUNCTIONS ---

// showStatus() dipertahankan tapi tidak akan terpanggil lagi di filterBooks()
function showStatus(message = '', icon = '', isVisible = true) {
    // Perlu dicek apakah statusMessage ada karena sudah dihapus dari HTML
    if (!statusMessage) return; 

    if (isVisible) {
        statusMessage.innerHTML = `<i class="${icon}" style="margin-right: 10px; color: var(--primary-color);"></i> ${message}`;
        statusMessage.style.display = 'block';
        bukuContainer.style.display = 'none'; 
    } else {
        statusMessage.style.display = 'none';
        bukuContainer.style.display = 'grid'; 
    }
}


// 1. Ambil Data Peminjaman Aktif (Hanya Inventarisnya)
function fetchPeminjamanStatus() {
    return new Promise((resolve) => {
        db.ref(PEMINJAMAN_PATH).once("value", snap => {
            activePeminjamanInvs.clear();
            if (snap.exists()) {
                snap.forEach(child => {
                    const kodeBuku = child.val().kode; 
                    if (kodeBuku) {
                        activePeminjamanInvs.add(kodeBuku);
                    }
                });
            }
            resolve();
        });
    });
}


// 2. Ambil dan Monitor Data Buku
function fetchBukuData() {
    db.ref(BUKU_PATH).on("value", snap => {
        allBukuData = {};
        if (snap.exists()) {
            snap.forEach(child => {
                allBukuData[child.key] = child.val(); 
            });
            filterBooks(); 
        } else {
            allBukuData = {};
            renderCards({}); 
            // showStatus("Tidak ada data buku yang tersedia.", 'fas fa-inbox', true); // Dihapus/dinonaktifkan
        }
    }, error => {
        console.error("Error loading data from Firebase:", error);
        // showStatus(`Gagal memuat data: ${error.message}`, 'fas fa-server', true); // Dihapus/dinonaktifkan
    });
}


// 3. Render Cards ke Halaman
function renderCards(data) {
    bukuContainer.innerHTML = "";
    const keys = Object.keys(data);

    if (keys.length === 0) {
        const filter = searchInput.value.toLowerCase().trim();
        
        if (filter.length >= 2 && Object.keys(allBukuData).length > 0) {
            // Jika tidak ada hasil untuk 2 huruf ke atas
            if (statusMessage) {
                showStatus(`Tidak ditemukan hasil untuk "${filter}".`, 'fas fa-search-minus', true);
            } else {
                bukuContainer.innerHTML = `<div style="text-align:center; padding: 20px;">Tidak ditemukan hasil untuk "${filter}".</div>`;
            }
        } else if (Object.keys(allBukuData).length > 0 && filter.length < 2) {
             // KONDISI INI DIATUR HANYA MENGOSONGKAN WADAH SAJA
             // Tidak menampilkan pesan "Ketik minimal 2 huruf..."
             showStatus(null, null, false); 
             bukuContainer.innerHTML = "";
        }
        return;
    }
    
    showStatus(null, null, false); 

    for (const inv in data) {
        const d = data[inv];
        const card = document.createElement("div");
        card.className = "buku-card";

        const isDipinjam = activePeminjamanInvs.has(inv);
        
        let statusKeterangan, statusClass, statusIcon;

        if (isDipinjam) {
            card.classList.add('dipinjam');
            statusKeterangan = 'SEDANG DIPINJAM';
            statusClass = 'status-borrowed';
            statusIcon = 'fas fa-times-circle';
        } else {
            statusKeterangan = 'TERSEDIA';
            statusClass = 'status-available';
            statusIcon = 'fas fa-check-circle';
        }

        const cardHTML = `
            <div class="card-content">
                <h3 class="card-title">
                    <i class="fas fa-book"></i>
                    ${d.judul || 'Judul Tidak Tersedia'}
                </h3>
                
                <div class="card-detail">
                    <i class="fas fa-user-edit"></i>
                    <span class="detail-label">Pengarang:</span>
                    <span class="detail-value">${d.pengarang || '-'}</span>
                </div>
                
                <div class="card-detail">
                    <i class="fas fa-box"></i>
                    <span class="detail-label">Lokasi:</span>
                    <span class="detail-value">Blok ${d.blok || '-'} / Rak ${d.rak || '-'}</span>
                </div>
                
                <div class="card-detail">
                    <i class="fas fa-barcode"></i>
                    <span class="detail-label">No. Inv:</span>
                    <span class="detail-value">${inv}</span>
                </div>
            </div>
            
            <div class="card-status ${statusClass}">
                <i class="${statusIcon}"></i> ${statusKeterangan}
            </div>
        `;
        
        card.innerHTML = cardHTML;
        bukuContainer.appendChild(card);
    }
}


// 4. Fitur Pencarian (Filtering)
function filterBooks() {
    const filter = searchInput.value.toLowerCase().trim();
    const filteredData = {};

    // Cek apakah filter memiliki minimal 2 karakter
    if (filter.length < 2) {
        // HANYA MENGOSONGKAN WADAH SAJA, TIDAK ADA PESAN STATUS
        renderCards({}); 
        bukuContainer.innerHTML = ""; // Pastikan wadah kosong
        showStatus(null, null, false); 

        // Jika input kosong, bahkan tidak perlu menampilkan pesan "Tidak ditemukan hasil"
        if (filter.length === 0) {
            bukuContainer.innerHTML = "";
        }
        return; 
    }

    // Jika filter >= 2 karakter, lanjutkan proses filtering
    for (const inv in allBukuData) {
        const d = allBukuData[inv];
        const searchableText = `${d.judul} ${d.pengarang} ${d.blok} ${d.rak} ${inv}`.toLowerCase();
        
        if (searchableText.includes(filter)) {
            filteredData[inv] = d;
        }
    }
    renderCards(filteredData);
}

// --- INITIALIZATION ---
window.onload = async () => {
    // Pesan loading di awal juga dihapus
    
    // 1. Ambil status peminjaman dulu
    await fetchPeminjamanStatus(); 
    
    // 2. Kemudian, mulai memonitor data buku
    fetchBukuData(); 
    
    // Selain itu, kita perlu memonitor peminjaman secara real-time juga
    db.ref(PEMINJAMAN_PATH).on("value", async () => {
        await fetchPeminjamanStatus(); 
        filterBooks(); 
    });
};
</script>

</body>
</html>
