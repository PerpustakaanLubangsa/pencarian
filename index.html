<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pencarian Buku - Perpustakaan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
/* --- BOX-SIZING UNIVERSAL --- */
*, *::before, *::after {
    box-sizing: border-box;
}

/* --- VARIABEL DASAR --- */
:root {
    --primary-color: #00bcd4;     
    --text-dark: #006064;         
    --bg-body: #f7f9fc;           
    --border-light: #e0e0e0;      
    --warning-orange: #f39c12; 
    --success-green: #2ecc71; 
}

/* ================================================= */
/* --- CSS UNTUK MENYEMBUNYIKAN SCROLLBAR --- */
/* ================================================= */
::-webkit-scrollbar {
    display: none; 
    width: 0;     
}

body { 
    -ms-overflow-style: none;
    scrollbar-width: none;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: var(--bg-body); 
    margin: 0; 
    padding: 20px 15px; 
    color: var(--text-dark); 
}

/* 2. Container Pembungkus */
.container {
    max-width: 1200px; 
    margin: auto;
    padding: 20px;
    border-radius: 12px;
}

/* --- Area Pencarian --- */
#searchContainer { 
    margin-bottom: 30px; 
    text-align: center; 
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
}
#searchInput {
    padding: 12px 20px; 
    border: 1px solid var(--border-light);
    border-radius: 30px; 
    width: 100%; 
    font-size: 1.1em; 
    transition: border-color 0.3s, box-shadow 0.3s;
    outline: none;
    background-color: #ffffff;
}
#searchInput:focus { 
    border-color: var(--primary-color); 
    box-shadow: 0 0 8px rgba(0, 188, 212, 0.3); 
}

/* --- GAYA TOMBOL BUKU ACAK --- */
#randomBookButton, #nextRandomButton {
    display: block; 
    width: auto; 
    margin: 15px auto 0 auto; 
    padding: 10px 15px;
    background-color: var(--success-green); 
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 600;
    transition: background-color 0.3s, transform 0.1s;
}

#randomBookButton:hover, #nextRandomButton:hover {
    background-color: #27ae60; 
}

#randomBookButton i, #nextRandomButton i {
    margin-right: 8px;
}

/* GAYA TOMBOL ACAK JUDUL LAIN DI MODAL */
#nextRandomButton {
    background-color: var(--primary-color);
    margin: 0 auto 15px auto; 
}
/* --- AKHIR GAYA TOMBOL ACAK --- */


/* --- GAYA MODAL/POP-UP --- */
.modal {
    display: none; 
    position: fixed; 
    z-index: 1000; 
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6); 
    padding-top: 60px;
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto; 
    padding: 20px;
    border-radius: 15px;
    width: 80%;
    max-width: 450px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    animation: fadeIn 0.3s;
    border-top: 5px solid var(--primary-color);
}

@keyframes fadeIn {
    from {opacity: 0; transform: translateY(-20px);}
    to {opacity: 1; transform: translateY(0);}
}

.close-button {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    line-height: 20px; 
    margin-left: 10px;
}

.close-button:hover,
.close-button:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    margin-bottom: 15px;
    border-bottom: 1px solid var(--border-light);
}

.modal-title {
    color: var(--text-dark);
    font-size: 1.5em;
    margin: 0;
}

.modal-title i {
    margin-right: 8px;
}

#randomBookDetail p {
    margin: 5px 0;
    font-size: 1em;
}

#randomBookDetail .label {
    font-weight: 600;
    color: #34495e;
}
/* --- AKHIR GAYA MODAL --- */


/* --- GAYA PESAN STATUS: DIPERBARUI --- */
.status-message {
    /* Untuk memastikan pesan status mengambil lebar penuh di dalam grid */
    grid-column: 1 / -1; 
    text-align: center;
    padding: 20px; 
    font-size: 1.1em;
    width: 100%;
}
/* --- AKHIR GAYA PESAN STATUS --- */


/* --- GAYA CARD BUKU TETAP SAMA --- */
#bukuContainer {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
    gap: 20px; 
    padding: 0;
}
/* ... (Gaya card lainnya tetap sama) ... */
.buku-card {
    background: #ffffff; 
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
    padding: 15px; 
    transition: box-shadow 0.3s, transform 0.2s; 
    border-left: 5px solid var(--primary-color); 
    position: relative;
    display: flex; 
    flex-direction: column;
}
.card-title {
    font-size: 1.2em; 
    font-weight: 700;
    color: var(--text-dark);
    margin: 0 0 10px 0;
    line-height: 1.4;
    display: flex;
    align-items: flex-start;
}
.card-detail {
    margin-bottom: 8px; 
    padding: 6px 0; 
    display: flex; 
    align-items: center;
    font-size: 0.95em;
    border-top: 1px dashed #eee;
}
.detail-label {
    font-weight: 600;
    color: #34495e;
    margin-right: 5px;
}
.card-status {
    margin-top: 15px; 
    padding-top: 10px;
    border-top: 2px solid var(--border-light);
    text-align: center;
    font-weight: 700;
    padding-bottom: 5px;
    text-transform: uppercase;
}
.status-available {
    color: var(--success-green);
}
.status-borrowed {
    color: var(--warning-orange);
}
</style>
</head>
<body>

<div class="container">
    <div id="searchContainer">
        <input type="text" id="searchInput" placeholder="Cari Judul, Pengarang, atau No. Inventaris..." oninput="filterBooks()" autocomplete="off">
        <button id="randomBookButton" onclick="showRandomBookPopup()">
            <i class="fas fa-magic"></i> Temukan Buku Acak
        </button>
    </div>

    <div id="bukuContainer">
        </div>
</div>

<div id="randomBookModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-dice"></i> Rekomendasi Buku Acak</h3>
            <span class="close-button" onclick="closeModal()">&times;</span>
        </div>
        
        <button id="nextRandomButton" onclick="showRandomBookPopup()"><i class="fas fa-redo-alt"></i> Acak Judul Lain</button>

        <div id="randomBookDetail">
            <p>Memuat...</p>
        </div>
    </div>
</div>
<script>
// --- Konfigurasi Firebase ---
const firebaseConfig = {
    // GANTI DENGAN KONFIGURASI FIREBASE ASLI ANDA
    apiKey: "AIzaSyByw2om-sKHqgCWBDcE7FEtONoUoJbn9M",
    authDomain: "traying-29bf4.firebaseapp.com",
    databaseURL: "https://traying-29bf4-default-rtdb.firebaseio.com",
    projectId: "traying-29bf4",
    storageBucket: "traying-29bf4.appspot.com",
    messagingSenderId: "42080663883",
    appId: "1:42080663883:web:58f28d5d1164204457d030"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- PATH KONSISTEN ---
const BUKU_PATH = "buku_v2"; 
const PEMINJAMAN_PATH = "peminjaman_v2"; 

// --- STATE GLOBAL & ELEMEN ---
let allBukuData = {}; 
let filteredBukuData = {}; 
let activePeminjamanInvs = new Set(); 
const bukuContainer = document.getElementById("bukuContainer");
const searchInput = document.getElementById("searchInput");
const randomBookButton = document.getElementById("randomBookButton");
const randomBookModal = document.getElementById("randomBookModal");
const randomBookDetail = document.getElementById("randomBookDetail");


// --- HELPER MODAL ---
function closeModal() {
    randomBookModal.style.display = 'none';
}

window.onclick = function(event) {
    if (event.target == randomBookModal) {
        closeModal();
    }
}


// --- FUNGSI Tampilkan Pop-up Buku Acak ---
function showRandomBookPopup() {
    const allKeys = Object.keys(filteredBukuData); 

    if (allKeys.length === 0) {
        randomBookDetail.innerHTML = '<p>Maaf, tidak ada data buku dengan nomor inventaris numerik yang tersedia.</p>';
        randomBookModal.style.display = 'block';
        return;
    }
    
    const randomKey = allKeys[Math.floor(Math.random() * allKeys.length)];
    const d = filteredBukuData[randomKey]; 
    const isDipinjam = activePeminjamanInvs.has(randomKey);
    
    const statusText = isDipinjam ? `<span style="color: var(--warning-orange); font-weight: bold;"><i class="fas fa-times-circle"></i> SEDANG DIPINJAM</span>` 
                                  : `<span style="color: var(--success-green); font-weight: bold;"><i class="fas fa-check-circle"></i> TERSEDIA</span>`;

    const contentHTML = `
        <p style="font-size: 1.3em; font-weight: 700; color: var(--primary-color);"><i class="fas fa-book" style="margin-right: 8px;"></i>${d.judul || 'Judul Tidak Tersedia'}</p>
        <p><span class="label">Pengarang:</span> ${d.pengarang || '-'}</p>
        <p><span class="label">Lokasi:</span> Blok ${d.blok || '-'} / Rak ${d.rak || '-'}</p>
        <p><span class="label">No. Inv:</span> ${randomKey}</p>
        <p style="margin-top: 15px;"><span class="label">Status:</span> ${statusText}</p>
    `;
    
    randomBookDetail.innerHTML = contentHTML;
    randomBookModal.style.display = 'block';
}


// FUNGSI Memfilter data buku hanya yang inventarisnya numerik
function filterNumericKeys(data) {
    const numericData = {};
    for (const key in data) {
        if (/^\d+$/.test(key)) {
            numericData[key] = data[key];
        }
    }
    return numericData;
}


// 1. Ambil Data Peminjaman Aktif
function fetchPeminjamanStatus() {
    return new Promise((resolve) => {
        db.ref(PEMINJAMAN_PATH).once("value", snap => {
            activePeminjamanInvs.clear();
            if (snap.exists()) {
                snap.forEach(child => {
                    const kodeBuku = child.val().kode; 
                    if (kodeBuku) {
                        activePeminjamanInvs.add(kodeBuku);
                    }
                });
            }
            resolve();
        });
    });
}


// 2. Ambil dan Monitor Data Buku
function fetchBukuData() {
    db.ref(BUKU_PATH).on("value", snap => {
        allBukuData = {};
        if (snap.exists()) {
            snap.forEach(child => {
                allBukuData[child.key] = child.val(); 
            });
            filteredBukuData = filterNumericKeys(allBukuData);
            filterBooks(); 
        } else {
            allBukuData = {};
            filteredBukuData = {};
            filterBooks(); 
        }
    }, error => {
        console.error("Error loading data from Firebase:", error);
    });
}


// 3. Render Cards ke Halaman
function renderCards(data) {
    bukuContainer.innerHTML = "";
    const keys = Object.keys(data);

    if (keys.length === 0) {
        const filter = searchInput.value.toLowerCase().trim();
        let messageHTML = '';
        let messageClass = '';

        if (filter.length >= 2 && Object.keys(filteredBukuData).length > 0) {
             messageHTML = `<i class="fas fa-search-minus" style="margin-right: 10px;"></i> Tidak ditemukan hasil untuk "${filter}".`;
             messageClass = 'color:#34495e;';
        } else if (filter.length === 0 && Object.keys(filteredBukuData).length > 0) {
            // PESAN INI DIRATATENGAHKAN MELALUI KELAS status-message
             messageHTML = `<i class="fas fa-search" style="margin-right: 10px;"></i> Masukkan minimal 2 huruf untuk memulai pencarian.`;
             messageClass = 'color:#34495e;';
        } else if (filter.length === 0 && Object.keys(allBukuData).length > 0) {
            messageHTML = `<i class="fas fa-exclamation-triangle" style="margin-right: 10px;"></i> Data buku yang memiliki nomor inventaris numerik tidak ditemukan.`;
            messageClass = 'color:#e74c3c;';
        }
        
        // Buat elemen div status
        if (messageHTML) {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status-message'; // Menggunakan kelas status-message
            statusDiv.style.cssText = messageClass;
            statusDiv.innerHTML = messageHTML;

            bukuContainer.appendChild(statusDiv);
        }
        return; 
    }
    
    // Tampilkan Card
    for (const inv in data) {
        const d = data[inv];
        const card = document.createElement("div");
        card.className = "buku-card";
        
        const isDipinjam = activePeminjamanInvs.has(inv);
        let statusKeterangan, statusClass, statusIcon;

        if (isDipinjam) {
            card.classList.add('dipinjam');
            statusKeterangan = 'SEDANG DIPINJAM';
            statusClass = 'status-borrowed';
            statusIcon = 'fas fa-times-circle';
        } else {
            statusKeterangan = 'TERSEDIA';
            statusClass = 'status-available';
            statusIcon = 'fas fa-check-circle';
        }

        const cardHTML = `
            <div class="card-content">
                <h3 class="card-title">
                    <i class="fas fa-book"></i>
                    ${d.judul || 'Judul Tidak Tersedia'}
                </h3>
                
                <div class="card-detail">
                    <i class="fas fa-user-edit"></i>
                    <span class="detail-label">Pengarang:</span>
                    <span class="detail-value">${d.pengarang || '-'}</span>
                </div>
                
                <div class="card-detail">
                    <i class="fas fa-box"></i>
                    <span class="detail-label">Lokasi:</span>
                    <span class="detail-value">Blok ${d.blok || '-'} / Rak ${d.rak || '-'}</span>
                </div>
                
                <div class="card-detail">
                    <i class="fas fa-barcode"></i>
                    <span class="detail-label">No. Inv:</span>
                    <span class="detail-value">${inv}</span>
                </div>
            </div>
            
            <div class="card-status ${statusClass}">
                <i class="${statusIcon}"></i> ${statusKeterangan}
            </div>
        `;
        
        card.innerHTML = cardHTML;
        bukuContainer.appendChild(card);
    }
}


// 4. Fitur Pencarian (Filtering)
function filterBooks() {
    const filter = searchInput.value.toLowerCase().trim();

    // KONDISI A: Input Pencarian Kosong
    if (filter.length < 2) {
        randomBookButton.style.display = 'block'; 
        renderCards({}); 
        return; 
    }

    // KONDISI B: Filtering Aktif (Filter length >= 2)
    randomBookButton.style.display = 'none'; 
    
    const filteredDataBySearch = {};
    
    for (const inv in filteredBukuData) {
        const d = filteredBukuData[inv];
        const searchableText = `${d.judul} ${d.pengarang} ${d.blok} ${d.rak} ${inv}`.toLowerCase();
        
        if (searchableText.includes(filter)) {
            filteredDataBySearch[inv] = d;
        }
    }
    renderCards(filteredDataBySearch);
}


// --- INITIALIZATION ---
window.onload = async () => {
    await fetchPeminjamanStatus(); 
    fetchBukuData(); 
    
    db.ref(PEMINJAMAN_PATH).on("value", async () => {
        await fetchPeminjamanStatus(); 
        filterBooks(); 
    });
};
</script>

</body>
</html>
